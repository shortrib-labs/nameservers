#!/bin/bash
#
# Pre-commit hook to verify secrets/params.yaml is SOPS-encrypted
#

PARAMS_FILE="secrets/params.yaml"

# Check if params.yaml is being committed
if git diff --cached --name-only | grep -q "^${PARAMS_FILE}$"; then
    # Write staged content to temp file for sops to check
    TMPFILE=$(mktemp -t params.XXXXXX.yaml)
    chmod 600 "$TMPFILE"
    trap "rm -f '$TMPFILE'" EXIT

    git show ":${PARAMS_FILE}" > "$TMPFILE" 2>/dev/null

    if [ ! -s "$TMPFILE" ]; then
        # File is being deleted, that's fine
        exit 0
    fi

    # Use sops filestatus to check encryption
    if ! sops filestatus "$TMPFILE" 2>/dev/null | grep -q '"encrypted":true'; then
        echo "ERROR: ${PARAMS_FILE} is not encrypted by SOPS!"
        echo ""
        echo "Run: make encrypt"
        echo ""
        exit 1
    fi

    echo "SOPS encryption verified for ${PARAMS_FILE}"
fi

exit 0
